@model Javo2.ViewModels.Operaciones.Ventas.VentaFormViewModel
@{
    ViewData["Title"] = "Imprimir Cotización";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid py-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Cotización</h2>
        <div>
            <button id="btnImprimir" class="btn btn-primary me-2">
                <i class="bi bi-printer me-1"></i> Imprimir
            </button>
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Volver
            </a>
        </div>
    </div>

    <div class="card bg-white text-dark" id="imprimible">
        <div class="card-body">
            <!-- Encabezado -->
            <div class="row mb-4">
                <div class="col-6">
                    <h1 class="text-dark fs-2 fw-bold">COTIZACIÓN</h1>
                    <p class="text-muted mb-0">N° @Model.NumeroFactura</p>
                    <p class="text-muted mb-0">Fecha: @Model.FechaVenta.ToString("dd/MM/yyyy")</p>
                </div>
                <div class="col-6 text-end">
                    <h2 class="text-dark fs-3 fw-bold mb-0">The BuryCode</h2>
                    <p class="text-muted mb-0">info@burycode.com.ar</p>
                    <p class="text-muted mb-0">+54 11 4567-8900</p>
                    <p class="text-muted mb-0">CUIT: 30-12345678-9</p>
                </div>
            </div>

            <hr class="my-4" />

            <!-- Datos del Cliente -->
            <div class="row mb-4">
                <div class="col-12">
                    <h4 class="text-dark">Datos del Cliente</h4>
                </div>
                <div class="col-md-6">
                    <p class="mb-1"><strong>Cliente:</strong> @Model.NombreCliente</p>
                    <p class="mb-1"><strong>DNI:</strong> @Model.DniCliente</p>
                    <p class="mb-1"><strong>Teléfono:</strong> @Model.TelefonoCliente</p>
                    <p class="mb-1"><strong>Celular:</strong> @Model.CelularCliente</p>
                </div>
                <div class="col-md-6">
                    <p class="mb-1"><strong>Domicilio:</strong> @Model.DomicilioCliente</p>
                    <p class="mb-1"><strong>Localidad:</strong> @Model.LocalidadCliente</p>
                    <p class="mb-1"><strong>Vendedor:</strong> @Model.Vendedor</p>
                </div>
            </div>

            <!-- Tabla de Productos -->
            <div class="mb-4">
                <h4 class="text-dark">Detalle de Productos</h4>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>Código</th>
                                <th>Producto</th>
                                <th class="text-center">Cantidad</th>
                                <th class="text-end">Precio Unit.</th>
                                <th class="text-end">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var producto in Model.ProductosPresupuesto)
                            {
                                <tr>
                                    <td>@(string.IsNullOrEmpty(producto.CodigoAlfa) ? producto.CodigoBarra : producto.CodigoAlfa)</td>
                                    <td>@producto.NombreProducto</td>
                                    <td class="text-center">@producto.Cantidad</td>
                                    <td class="text-end">@producto.PrecioUnitario.ToString("C")</td>
                                    <td class="text-end">@((producto.Cantidad * producto.PrecioUnitario).ToString("C"))</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="2" class="text-end">Totales:</th>
                                <th class="text-center">@Model.ProductosPresupuesto.Sum(p => p.Cantidad)</th>
                                <th colspan="1"></th>
                                <th class="text-end">@Model.ProductosPresupuesto.Sum(p => p.Cantidad * p.PrecioUnitario).ToString("C")</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Observaciones y Condiciones -->
            <div class="row">
                <div class="col-md-6">
                    <h4 class="text-dark">Observaciones</h4>
                    <p class="border p-2 bg-light">@(string.IsNullOrEmpty(Model.Observaciones) ? "Sin observaciones" : Model.Observaciones)</p>
                </div>
                <div class="col-md-6">
                    <h4 class="text-dark">Condiciones</h4>
                    <p class="border p-2 bg-light">@(string.IsNullOrEmpty(Model.Condiciones) ? "Cotización válida por 30 días" : Model.Condiciones)</p>
                </div>
            </div>

            <!-- Nota de pie -->
            <div class="text-center mt-5">
                <p class="text-muted mb-1">Cotización generada el @DateTime.Now.ToString("dd/MM/yyyy HH:mm")</p>
                <p class="text-muted mb-0">Esta cotización no representa un compromiso de venta.</p>
                <p class="text-muted mb-0">Los precios pueden estar sujetos a cambios sin previo aviso.</p>
                <p class="text-muted mb-4">Para confirmar la operación, por favor comuníquese con nuestro departamento de ventas.</p>
            </div>

            <!-- Firma -->
            <div class="row mt-5">
                <div class="col-6 text-center">
                    <div class="border-top border-dark pt-2 mt-5 mx-5">
                        <p class="mb-0">Firma del Cliente</p>
                    </div>
                </div>
                <div class="col-6 text-center">
                    <div class="border-top border-dark pt-2 mt-5 mx-5">
                        <p class="mb-0">Firma del Vendedor</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('btnImprimir').addEventListener('click', function() {
            const contenido = document.getElementById('imprimible').innerHTML;
            const ventanaImpresion = window.open('', '_blank');

            ventanaImpresion.document.write(`
                <!DOCTYPE html>
                <html lang="es">
                <head>
                    <meta charset="UTF-8">
                    <title>Cotización @Model.NumeroFactura</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                        }
        @media print {
                            .no-print { display: none; }
                            a { text-decoration: none; color: #000; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        ${contenido}
                    </div>
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() { window.close(); }, 500);
                        }
    </script>
                    </body>
                    </html>
                `);

                ventanaImpresion.document.close();
        });
    </script>
}