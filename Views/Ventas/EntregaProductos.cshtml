@model IEnumerable<Javo2.ViewModels.Operaciones.Ventas.VentaListViewModel>

    @{
    ViewBag.Title = "Ventas Pendientes de Entrega";
    Layout = "~/Views/Shared/_Layout.cshtml";
    }

    <h2 class="mb-4">@ViewBag.Title</h2>

    <!-- Resumen de Entregas -->
    <div class="summary-cards mb-4">
        <div class="summary-card">
            <h5>Total Pendientes</h5>
            <p>@Model.Count()</p>
        </div>
        <div class="summary-card">
            <h5>Productos a Entregar</h5>
            <p>@Model.Sum(v => v.TotalProductos)</p>
        </div>
        <div class="summary-card">
            <h5>Monto Total</h5>
            <p>@Model.Sum(v => v.PrecioTotal).ToString("C")</p>
        </div>
    </div>

    <!-- Tabla de Ventas Pendientes de Entrega -->
    <div class="card p-3">
        <div class="table-responsive">
            <table class="table table-dark table-striped align-middle">
                <thead>
                    <tr>
                        <th>Fecha Venta</th>
                        <th>Factura</th>
                        <th>Cliente</th>
                        <th>Productos</th>
                        <th>Total</th>
                        <th>Dirección</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var venta in Model)
                {
                    <tr>
                        <td>@venta.FechaVenta.ToString("dd/MM/yyyy")</td>
                        <td>@venta.NumeroFactura</td>
                        <td>@venta.NombreCliente</td>
                        <td>@venta.TotalProductos</td>
                        <td>@venta.PrecioTotal.ToString("C")</td>
                        <td>@venta.DomicilioCliente</td>
                        <td>
                            <div class="btn-group">
                                <a asp-action="Details" asp-route-id="@venta.VentaID"
                                   class="btn btn-info btn-sm" title="Ver Detalles">
                                    <i class="bi bi-eye"></i> Detalles
                                </a>
                                <button type="button" class="btn btn-success btn-sm marcar-entregada"
                                        data-id="@venta.VentaID" title="Marcar como Entregada">
                                    <i class="bi bi-check-square"></i> Marcar Entregada
                                </button>
                                <a asp-action="Reimprimir" asp-route-id="@venta.VentaID"
                                   class="btn btn-secondary btn-sm" title="Imprimir Remito">
                                    <i class="bi bi-printer"></i> Remito
                                </a>
                            </div>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </div>

    @if (!Model.Any())
{
    <div class="alert alert-info mt-3">
        <i class="bi bi-info-circle me-2"></i>
        No hay ventas pendientes de entrega en este momento.
    </div>
}

    <div class="mt-3">
        <a asp-action="Index" class="btn btn-secondary">
            <i class="bi bi-arrow-left me-1"></i> Volver al Listado
        </a>
    </div>

    <!-- Modal para confirmar entrega -->
    <div class="modal fade" id="confirmarEntregaModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Entrega</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro que desea marcar esta venta como entregada?</p>
                    <p class="text-muted">Esta acción finalizará el proceso de venta.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" id="confirmarEntrega">Confirmar Entrega</button>
                </div>
            </div>
        </div>
    </div>

    @section Scripts {
        <script>
    $(document).ready(function() {
        let ventaIdSeleccionada = null;

        // Marcar como entregada
        $('.marcar-entregada').click(function() {
            ventaIdSeleccionada = $(this).data('id');
            $('#confirmarEntregaModal').modal('show');
        });

        // Confirmar entrega
        $('#confirmarEntrega').click(function() {
            if (ventaIdSeleccionada) {
                $('#confirmarEntregaModal').modal('hide');

                $.ajax({
                    url: '@Url.Action("MarcarEntregada", "Ventas")',
                    type: 'POST',
                    data: {
                        id: ventaIdSeleccionada,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            toastr.success('Venta marcada como entregada exitosamente');
                            // Eliminar la fila de la tabla
                            $(`tr button[data-id="${ventaIdSeleccionada}"]`).closest('tr').fadeOut(400, function() {
                                $(this).remove();
                                // Si no quedan más ventas, recargar la página
                                if ($('.table tbody tr').length === 0) {
                                    location.reload();
                                }
                            });
                        } else {
                            toastr.error(response.message || 'Error al marcar la venta como entregada');
                        }
                    },
                    error: function() {
                        toastr.error('Error al procesar la solicitud');
                    }
                });
            }
        });
    });
        </script>
    }
