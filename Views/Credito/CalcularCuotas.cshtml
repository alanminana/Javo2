@model Javo2.ViewModels.Operaciones.Ventas.VentaCreditoViewModel
@{
    ViewData["Title"] = "Configurar Crédito";
}

<div class="card bg-dark text-light">
    <div class="card-header">
        <h3>Configurar Plan de Crédito</h3>
    </div>
    <div class="card-body">
        <div class="row mb-4">
            <div class="col-md-6">
                <h4>Información de Venta</h4>
                <dl class="row">
                    <dt class="col-sm-4">Factura</dt>
                    <dd class="col-sm-8">@Model.NumeroFactura</dd>

                    <dt class="col-sm-4">Fecha</dt>
                    <dd class="col-sm-8">@Model.FechaVenta.ToString("dd/MM/yyyy")</dd>

                    <dt class="col-sm-4">Cliente</dt>
                    <dd class="col-sm-8">@Model.ClienteNombre</dd>

                    <dt class="col-sm-4">Calificación</dt>
                    <dd class="col-sm-8">
                        @if (Model.ScoreCliente == "A")
                        {
                            <span class="badge bg-success">A - Excelente</span>
                        }
                        else if (Model.ScoreCliente == "B")
                        {
                            <span class="badge bg-primary">B - Bueno</span>
                        }
                        else if (Model.ScoreCliente == "C")
                        {
                            <span class="badge bg-warning text-dark">C - Regular</span>
                        }
                        else if (Model.ScoreCliente == "D")
                        {
                            <span class="badge bg-danger">D - Malo</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Sin calificación</span>
                        }
                    </dd>

                    <dt class="col-sm-4">Total</dt>
                    <dd class="col-sm-8">@Model.MontoTotal.ToString("C")</dd>

                    <dt class="col-sm-4">Requiere Garante</dt>
                    <dd class="col-sm-8">
                        @if (Model.RequiereGarante)
                        {
                            if (Model.TieneGarante)
                            {
                                <span class="badge bg-success">Requerido y Asignado</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">Requerido pero No Asignado</span>
                            }
                        }
                        else
                        {
                            <span class="badge bg-info">No Requerido</span>
                        }
                    </dd>
                </dl>
            </div>
            <div class="col-md-6">
                <h4>Configurar Plan de Cuotas</h4>
                <form asp-action="CalcularCuotas" method="post">
                    <input type="hidden" asp-for="VentaID" />
                    <input type="hidden" asp-for="ClienteID" />
                    <input type="hidden" asp-for="NumeroFactura" />
                    <input type="hidden" asp-for="ClienteNombre" />
                    <input type="hidden" asp-for="MontoTotal" />
                    <input type="hidden" asp-for="ScoreCliente" />
                    <input type="hidden" asp-for="RequiereGarante" />
                    <input type="hidden" asp-for="TieneGarante" />

                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                    <div class="form-group mb-3">
                        <label asp-for="NumeroCuotas" class="form-label">Número de Cuotas</label>
                        <select asp-for="NumeroCuotas" asp-items="Model.PlazosDisponibles" class="form-select bg-secondary text-light">
                            <option value="">-- Seleccione --</option>
                        </select>
                        <span asp-validation-for="NumeroCuotas" class="text-danger"></span>
                        <small class="text-muted">Máximo permitido: @Model.PlazoMaximo cuotas</small>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="FechaVencimiento" class="form-label">Fecha Primer Vencimiento</label>
                        <input asp-for="FechaVencimiento" type="date" class="form-control bg-secondary text-light" />
                        <span asp-validation-for="FechaVencimiento" class="text-danger"></span>
                    </div>

                    <div class="alert alert-info">
                        <p><strong>Información:</strong> Al proceder se calculará el recargo según la calificación crediticia del cliente.</p>
                        @if (Model.RequiereGarante && !Model.TieneGarante)
                        {
                            <p class="text-danger"><strong>Atención:</strong> Este cliente requiere un garante para acceder a crédito. Por favor, asigne un garante antes de continuar.</p>
                        }
                    </div>

                    <div class="mt-3">
                        @if (Model.RequiereGarante && !Model.TieneGarante)
                        {
                            <a asp-controller="Clientes" asp-action="AsignarGarante" asp-route-id="@Model.ClienteID" class="btn btn-primary">
                                Asignar Garante
                            </a>
                            <button type="submit" class="btn btn-success" disabled>Generar Plan de Pago</button>
                        }
                        else
                        {
                            <button type="submit" class="btn btn-success">Generar Plan de Pago</button>
                        }
                        <a asp-action="Details" asp-route-id="@Model.VentaID" class="btn btn-secondary">Cancelar</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>