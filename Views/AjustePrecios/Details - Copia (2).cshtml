<!-- Views/AjustePrecios/Details.cshtml -->
@model Javo2.ViewModels.Operaciones.Productos.AjustePrecioHistoricoViewModel
@{
    ViewBag.Title = "Detalle de Ajuste de Precios";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid py-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 mb-0">@ViewBag.Title #@Model.AjusteHistoricoID</h1>
        <div>
            @if (!Model.Revertido && User.HasPermission("productos.ajustarprecios"))
            {
                <form asp-action="Revert" method="post" class="d-inline" id="revertForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.AjusteHistoricoID" />
                    <button type="submit" class="btn btn-danger me-2" id="btnRevertir">
                        <i class="bi bi-arrow-counterclockwise me-1"></i>Revertir Ajuste
                    </button>
                </form>
            }
            <a asp-action="Index" class="btn btn-secondary">
                <i class="bi bi-arrow-left me-1"></i>Volver al Historial
            </a>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card bg-dark text-light h-100">
                <div class="card-header">
                    <h5 class="mb-0">Información del Ajuste</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-5">ID</dt>
                        <dd class="col-sm-7">@Model.AjusteHistoricoID</dd>

                        <dt class="col-sm-5">Fecha</dt>
                        <dd class="col-sm-7">@Model.FechaAjuste.ToString("dd/MM/yyyy HH:mm")</dd>

                        <dt class="col-sm-5">Usuario</dt>
                        <dd class="col-sm-7">@Model.UsuarioAjuste</dd>

                        <dt class="col-sm-5">Tipo</dt>
                        <dd class="col-sm-7">
                            <span class="badge @(Model.EsAumento ? "bg-success" : "bg-danger")">
                                @Model.TipoAjuste
                            </span>
                        </dd>

                        <dt class="col-sm-5">Porcentaje</dt>
                        <dd class="col-sm-7">@Model.Porcentaje.ToString("N2")%</dd>

                        <dt class="col-sm-5">Estado</dt>
                        <dd class="col-sm-7">
                            @if (Model.Revertido)
                            {
                                <span class="badge bg-warning text-dark">Revertido</span>
                            }
                            else
                            {
                                <span class="badge bg-success">Activo</span>
                            }
                        </dd>

                        @if (Model.Revertido)
                        {
                            <dt class="col-sm-5">Revertido Por</dt>
                            <dd class="col-sm-7">@Model.UsuarioReversion</dd>

                            <dt class="col-sm-5">Fecha Reversión</dt>
                            <dd class="col-sm-7">@Model.FechaReversion?.ToString("dd/MM/yyyy HH:mm")</dd>
                        }

                        @if (!string.IsNullOrEmpty(Model.Descripcion))
                        {
                            <dt class="col-sm-5">Descripción</dt>
                            <dd class="col-sm-7">@Model.Descripcion</dd>
                        }

                        <dt class="col-sm-5">Total Productos</dt>
                        <dd class="col-sm-7">@Model.CantidadProductos</dd>
                    </dl>
                </div>
            </div>
        </div>

        <div class="col-md-8 mb-4">
            <div class="card bg-dark text-light">
                <div class="card-header">
                    <h5 class="mb-0">Detalle de Productos Ajustados</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>P.Costo Anterior</th>
                                    <th>P.Costo Posterior</th>
                                    <th>Diferencia</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var detalle in Model.Detalles)
                                {
                                    <tr>
                                        <td>@detalle.NombreProducto</td>
                                        <td>@detalle.PCostoAnterior.ToString("C")</td>
                                        <td>@detalle.PCostoPosterior.ToString("C")</td>
                                        <td class="@(detalle.DiferenciaPCosto > 0 ? "text-success" : "text-danger")">
                                            @detalle.DiferenciaPCosto.ToString("C") (@detalle.PorcentajeCambio.ToString("P2"))
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            $('#btnRevertir').click(function (e) {
                if (!confirm('¿Está seguro que desea revertir este ajuste de precios? Esta acción restaurará los precios anteriores al ajuste.')) {
                    e.preventDefault();
                    return false;
                }
                return true;
            });
        });
    </script>
}