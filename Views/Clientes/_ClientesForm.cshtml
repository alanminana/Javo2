@model Javo2.ViewModels.Operaciones.Clientes.ClientesViewModel
@{
    bool isEdit = Model.ClienteID > 0;
    ViewData["Title"] = isEdit ? "Editar Cliente" : "Crear Cliente";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<section class="container-fluid py-3">
    <div class="card shadow-sm bg-dark text-light">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="h4 mb-0">@ViewData["Title"]</h2>
            <a asp-action="Index" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left me-1"></i> Volver al listado
            </a>
        </div>
        <div class="card-body">
            <form asp-action="@(isEdit ? "Edit" : "Create")" method="post" id="clienteForm">
                <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                <input type="hidden" asp-for="ClienteID" />

                <!-- Tabs para organizar información -->
                <ul class="nav nav-tabs" id="clienteTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="datos-personales-tab" data-bs-toggle="tab"
                                data-bs-target="#datos-personales" type="button" role="tab"
                                aria-controls="datos-personales" aria-selected="true">
                            Datos Personales
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="domicilio-tab" data-bs-toggle="tab"
                                data-bs-target="#domicilio" type="button" role="tab"
                                aria-controls="domicilio" aria-selected="false">
                            Domicilio
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="credito-tab" data-bs-toggle="tab"
                                data-bs-target="#credito" type="button" role="tab"
                                aria-controls="credito" aria-selected="false">
                            Crédito
                        </button>
                    </li>
                    @if (isEdit)
                    {
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="historial-tab" data-bs-toggle="tab"
                                    data-bs-target="#historial" type="button" role="tab"
                                    aria-controls="historial" aria-selected="false">
                                Historial
                            </button>
                        </li>
                    }
                </ul>

                <div class="tab-content pt-3" id="clienteTabsContent">
                    <!-- Datos Personales -->
                    <div class="tab-pane fade show active" id="datos-personales" role="tabpanel"
                         aria-labelledby="datos-personales-tab">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="Nombre" class="form-label">Nombre</label>
                                <input asp-for="Nombre" class="form-control bg-dark text-light" />
                                <span asp-validation-for="Nombre" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Apellido" class="form-label">Apellido</label>
                                <input asp-for="Apellido" class="form-control bg-dark text-light" />
                                <span asp-validation-for="Apellido" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="DNI" class="form-label">DNI</label>
                                <input asp-for="DNI" class="form-control bg-dark text-light" />
                                <span asp-validation-for="DNI" class="text-danger"></span>
                            </div>
                            <div class="col-md-8">
                                <label asp-for="Email" class="form-label">Email</label>
                                <input asp-for="Email" class="form-control bg-dark text-light" />
                                <span asp-validation-for="Email" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="Telefono" class="form-label">Teléfono</label>
                                <input asp-for="Telefono" class="form-control bg-dark text-light" />
                                <span asp-validation-for="Telefono" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="Celular" class="form-label">Celular</label>
                                <input asp-for="Celular" class="form-control bg-dark text-light" />
                                <span asp-validation-for="Celular" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="TelefonoTrabajo" class="form-label">Teléfono Trabajo</label>
                                <input asp-for="TelefonoTrabajo" class="form-control bg-dark text-light" />
                                <span asp-validation-for="TelefonoTrabajo" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch mt-4">
                                    <input asp-for="Activo" class="form-check-input" />
                                    <label asp-for="Activo" class="form-check-label">Activo</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Domicilio -->
                    <div class="tab-pane fade" id="domicilio" role="tabpanel" aria-labelledby="domicilio-tab">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="Calle" class="form-label">Calle</label>
                                <input asp-for="Calle" class="form-control bg-dark text-light" />
                                <span asp-validation-for="Calle" class="text-danger"></span>
                            </div>
                            <div class="col-md-2">
                                <label asp-for="NumeroCalle" class="form-label">Número</label>
                                <input asp-for="NumeroCalle" class="form-control bg-dark text-light" />
                                <span asp-validation-for="NumeroCalle" class="text-danger"></span>
                            </div>
                            <div class="col-md-2">
                                <label asp-for="NumeroPiso" class="form-label">Piso</label>
                                <input asp-for="NumeroPiso" class="form-control bg-dark text-light" />
                                <span asp-validation-for="NumeroPiso" class="text-danger"></span>
                            </div>
                            <div class="col-md-2">
                                <label asp-for="Dpto" class="form-label">Dpto</label>
                                <input asp-for="Dpto" class="form-control bg-dark text-light" />
                                <span asp-validation-for="Dpto" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="ProvinciaID" class="form-label">Provincia</label>
                                <select asp-for="ProvinciaID" asp-items="Model.Provincias"
                                        class="form-select bg-dark text-light" id="provincias">
                                    <option value="">-- Seleccione --</option>
                                </select>
                                <span asp-validation-for="ProvinciaID" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="CiudadID" class="form-label">Ciudad</label>
                                <select asp-for="CiudadID" asp-items="Model.Ciudades"
                                        class="form-select bg-dark text-light" id="ciudades">
                                    <option value="">-- Seleccione --</option>
                                </select>
                                <span asp-validation-for="CiudadID" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="Localidad" class="form-label">Localidad</label>
                                <input asp-for="Localidad" class="form-control bg-dark text-light" />
                                <span asp-validation-for="Localidad" class="text-danger"></span>
                            </div>
                            <div class="col-md-2">
                                <label asp-for="CodigoPostal" class="form-label">Código Postal</label>
                                <input asp-for="CodigoPostal" class="form-control bg-dark text-light" />
                                <span asp-validation-for="CodigoPostal" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="DescripcionDomicilio" class="form-label">Descripción</label>
                                <input asp-for="DescripcionDomicilio" class="form-control bg-dark text-light" />
                                <span asp-validation-for="DescripcionDomicilio" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Crédito -->
                    <div class="tab-pane fade" id="credito" role="tabpanel" aria-labelledby="credito-tab">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch mb-3">
                                    <input asp-for="AptoCredito" class="form-check-input" id="aptoCredito" />
                                    <label asp-for="AptoCredito" class="form-check-label">¿Apto para Crédito?</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch mb-3 credito-field">
                                    <input asp-for="RequiereGarante" class="form-check-input" id="requiereGarante" />
                                    <label asp-for="RequiereGarante" class="form-check-label">¿Requiere Garante?</label>
                                </div>
                            </div>
                            <div class="col-md-6 credito-field">
                                <label asp-for="LimiteCreditoInicial" class="form-label">Límite de Crédito Inicial</label>
                                <input asp-for="LimiteCreditoInicial" type="number" step="0.01" min="0"
                                       class="form-control bg-dark text-light" />
                                <span asp-validation-for="LimiteCreditoInicial" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="SaldoInicial" class="form-label">Saldo Inicial</label>
                                <input asp-for="SaldoInicial" type="number" step="0.01"
                                       class="form-control bg-dark text-light" readonly />
                            </div>
                        </div>

                        <!-- Información del Garante -->
                        <div id="garanteInfo" class="mt-4 d-none">
                            <h5 class="border-bottom pb-2">Información del Garante</h5>

                            @if (Model.GaranteID.HasValue && Model.GaranteID.Value > 0)
                            {
                                <div class="alert alert-info">
                                    <strong>Garante asignado:</strong> @Model.NombreGarante
                                    <a href="#" id="cambiarGarante" class="btn btn-sm btn-outline-primary ms-3">
                                        <i class="bi bi-pencil"></i> Cambiar Garante
                                    </a>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    No hay garante asignado. Por favor, asigne un garante.
                                </div>
                            }

                            <div id="garanteForm" class="@(Model.GaranteID.HasValue && Model.GaranteID.Value > 0 ? "d-none" : "")">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="GaranteNombre" class="form-label">Nombre del Garante</label>
                                        <input type="text" id="GaranteNombre" class="form-control bg-dark text-light" />
                                    </div>
                                    <div class="col-md-6">
                                        <label for="GaranteApellido" class="form-label">Apellido del Garante</label>
                                        <input type="text" id="GaranteApellido" class="form-control bg-dark text-light" />
                                    </div>
                                    <div class="col-md-4">
                                        <label for="GaranteDNI" class="form-label">DNI del Garante</label>
                                        <div class="input-group">
                                            <input type="text" id="GaranteDNI" class="form-control bg-dark text-light" />
                                            <button type="button" id="buscarGarante" class="btn btn-outline-primary">
                                                <i class="bi bi-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <label for="GaranteEmail" class="form-label">Email del Garante</label>
                                        <input type="email" id="GaranteEmail" class="form-control bg-dark text-light" />
                                    </div>
                                    <div class="col-md-6">
                                        <label for="GaranteTelefono" class="form-label">Teléfono del Garante</label>
                                        <input type="text" id="GaranteTelefono" class="form-control bg-dark text-light" />
                                    </div>
                                    <div class="col-md-6">
                                        <label for="GaranteDomicilio" class="form-label">Domicilio del Garante</label>
                                        <input type="text" id="GaranteDomicilio" class="form-control bg-dark text-light" />
                                    </div>
                                    <div class="col-md-6">
                                        <label for="GaranteTrabajo" class="form-label">Lugar de Trabajo</label>
                                        <input type="text" id="GaranteTrabajo" class="form-control bg-dark text-light" />
                                    </div>
                                    <div class="col-md-6">
                                        <label for="GaranteIngresos" class="form-label">Ingresos Mensuales</label>
                                        <input type="number" id="GaranteIngresos" step="0.01" min="0" class="form-control bg-dark text-light" />
                                    </div>
                                    <div class="col-md-12">
                                        <label for="GaranteRelacion" class="form-label">Relación con el Cliente</label>
                                        <select id="GaranteRelacion" class="form-select bg-dark text-light">
                                            <option value="">-- Seleccione --</option>
                                            <option value="Familiar">Familiar</option>
                                            <option value="Amigo">Amigo</option>
                                            <option value="Cónyuge">Cónyuge</option>
                                            <option value="Otro">Otro</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <button type="button" id="guardarGarante" class="btn btn-success">
                                            <i class="bi bi-save"></i> Guardar Garante
                                        </button>
                                        <input type="hidden" asp-for="GaranteID" id="garanteIdInput" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Historial (solo en edición) -->
                    @if (isEdit)
                    {
                        <div class="tab-pane fade" id="historial" role="tabpanel" aria-labelledby="historial-tab">
                            <div class="table-responsive">
                                <table class="table table-dark table-striped">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Producto</th>
                                            <th>Cantidad</th>
                                            <th>Precio Unit.</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (Model.HistorialCompras.Any())
                                        {
                                            @foreach (var compra in Model.HistorialCompras)
                                            {
                                                <tr>
                                                    <td>@compra.FechaCompra</td>
                                                    <td>@compra.Producto</td>
                                                    <td>@compra.Cantidad</td>
                                                    <td>@compra.PrecioUnitario.ToString("C")</td>
                                                    <td>@compra.Total.ToString("C")</td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="5" class="text-center">
                                                    No hay historial de compras para este cliente
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                </div>

                <div class="mt-4 d-flex justify-content-end gap-2">
                    <a asp-action="Index" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle me-1"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i> Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
</section>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
    <script>
        $(function() {
            // Manejo de Provincias y Ciudades
            $("#provincias").change(function() {
                var provinciaId = $(this).val();
                if (provinciaId) {
                    $.ajax({
                        url: "@Url.Action("GetCiudades")",
                        type: "GET",
                        data: { provinciaID: provinciaId },
                        success: function(data) {
                            var ciudades = $("#ciudades");
                            ciudades.empty();
                            ciudades.append('<option value="">-- Seleccione --</option>');
                            $.each(data, function(i, item) {
                                ciudades.append(`<option value="${item.value}">${item.text}</option>`);
                            });
                        },
                        error: function() {
                            alert("Error al cargar las ciudades");
                        }
                    });
                } else {
                    $("#ciudades").empty().append('<option value="">-- Seleccione --</option>');
                }
            });

            // Manejo de Crédito y Garante
            const toggleCreditoFields = function() {
                const aptoCredito = $("#aptoCredito").is(":checked");
                $(".credito-field").toggleClass("d-none", !aptoCredito);

                const requiereGarante = $("#requiereGarante").is(":checked");
                $("#garanteInfo").toggleClass("d-none", !(aptoCredito && requiereGarante));
            };

            $("#aptoCredito, #requiereGarante").change(toggleCreditoFields);

            toggleCreditoFields(); // Inicializar

            // Cambiar Garante
            $("#cambiarGarante").click(function(e) {
                e.preventDefault();
                $("#garanteForm").removeClass("d-none");
            });

            // Buscar Garante
            $("#buscarGarante").click(function() {
                const dni = $("#GaranteDNI").val();
                if (!dni) {
                    alert("Ingrese un DNI para buscar el garante");
                    return;
                }

                $.ajax({
                    url: "@Url.Action("BuscarGarantePorDNI", "Clientes")",
                    type: "GET",
                    data: { dni: dni },
                    success: function(data) {
                        if (data.success) {
                            $("#GaranteNombre").val(data.data.nombre);
                            $("#GaranteApellido").val(data.data.apellido);
                            $("#GaranteEmail").val(data.data.email);
                            $("#GaranteTelefono").val(data.data.telefono);
                            $("#GaranteDomicilio").val(data.data.domicilio);
                            $("#garanteIdInput").val(data.data.garanteId);
                        } else {
                            alert(data.message || "No se encontró un garante con ese DNI");
                        }
                    },
                    error: function() {
                        alert("Error al buscar el garante");
                    }
                });
            });

            // Guardar Garante
            $("#guardarGarante").click(function() {
                // Validaciones
                if (!$("#GaranteNombre").val() || !$("#GaranteApellido").val() ||
                    !$("#GaranteDNI").val() || !$("#GaranteEmail").val()) {
                    alert("Por favor, complete los campos obligatorios del garante");
                    return;
                }

                const garanteData = {
                    Nombre: $("#GaranteNombre").val(),
                    Apellido: $("#GaranteApellido").val(),
                    DNI: $("#GaranteDNI").val(),
                    Email: $("#GaranteEmail").val(),
                    Telefono: $("#GaranteTelefono").val(),
                    Domicilio: $("#GaranteDomicilio").val(),
                    LugarTrabajo: $("#GaranteTrabajo").val(),
                    IngresosMensuales: $("#GaranteIngresos").val(),
                    RelacionCliente: $("#GaranteRelacion").val(),
                    ClienteID: $("#ClienteID").val()
                };

                $.ajax({
                    url: "@Url.Action("GuardarGarante", "Clientes")",
                    type: "POST",
                    data: JSON.stringify(garanteData),
                    contentType: "application/json",
                    success: function(data) {
                        if (data.success) {
                            $("#garanteIdInput").val(data.data.garanteId);
                            alert("Garante guardado correctamente");

                            // Mostrar información resumida del garante
                            $("#garanteForm").addClass("d-none");
                            alert("Garante asignado correctamente");
                        } else {
                            alert(data.message || "Error al guardar el garante");
                        }
                    },
                    error: function() {
                        alert("Error al guardar el garante");
                    }
                });
            });
        });
    </script>
}