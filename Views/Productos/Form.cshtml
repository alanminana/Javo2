@model Javo2.ViewModels.Operaciones.Productos.ProductosViewModel

<div class="card bg-dark text-light">
    <div class="card-body">
        <form asp-action="@(Model.ProductoID > 0 ? "Edit" : "Create")" method="post">
            <input type="hidden" asp-for="ProductoID" />
            <input type="hidden" asp-for="ModificadoPor" value="@(User.Identity?.Name ?? "Sistema")" />

            <!-- Campos que no deben ser modificados manualmente -->
            <input type="hidden" asp-for="PContado" />
            <input type="hidden" asp-for="PLista" />

            <div class="row mb-3">
                <div class="col-md-6">
                    <label asp-for="Nombre" class="form-label">Nombre del Producto</label>
                    <input asp-for="Nombre" class="form-control bg-dark text-light" />
                    <span asp-validation-for="Nombre" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="SelectedRubroID" class="form-label">Rubro</label>
                    <div class="input-group">
                        <select asp-for="SelectedRubroID" asp-items="Model.Rubros" class="form-select bg-dark text-light" id="rubroDropdown">
                            <option value="">-- Seleccione Rubro --</option>
                        </select>
                        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#nuevoRubroModal">
                            <i class="bi bi-plus-circle"></i>
                        </button>
                    </div>
                    <span asp-validation-for="SelectedRubroID" class="text-danger"></span>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label asp-for="SelectedSubRubroID" class="form-label">SubRubro</label>
                    <div class="input-group">
                        <select asp-for="SelectedSubRubroID" asp-items="Model.SubRubros" class="form-select bg-dark text-light" id="subRubroDropdown">
                            <option value="">-- Seleccione SubRubro --</option>
                        </select>
                        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#nuevoSubRubroModal" id="btnAddSubRubro">
                            <i class="bi bi-plus-circle"></i>
                        </button>
                    </div>
                    <span asp-validation-for="SelectedSubRubroID" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="SelectedMarcaID" class="form-label">Marca</label>
                    <div class="input-group">
                        <select asp-for="SelectedMarcaID" asp-items="Model.Marcas" class="form-select bg-dark text-light">
                            <option value="">-- Seleccione Marca --</option>
                        </select>
                        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#nuevaMarcaModal">
                            <i class="bi bi-plus-circle"></i>
                        </button>
                    </div>
                    <span asp-validation-for="SelectedMarcaID" class="text-danger"></span>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-4">
                    <label asp-for="PCosto" class="form-label">Precio de Costo</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input asp-for="PCosto" class="form-control bg-dark text-light" id="pCosto" />
                    </div>
                    <span asp-validation-for="PCosto" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Precio de Contado (calculado)</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input id="pContadoDisplay" class="form-control bg-dark text-light" readonly />
                    </div>
                    <small class="text-muted">Cálculo automático</small>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Precio de Lista (calculado)</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input id="pListaDisplay" class="form-control bg-dark text-light" readonly />
                    </div>
                    <small class="text-muted">Cálculo automático</small>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label asp-for="PorcentajeIva" class="form-label">Porcentaje IVA</label>
                    <div class="input-group">
                        <input asp-for="PorcentajeIva" class="form-control bg-dark text-light" />
                        <span class="input-group-text">%</span>
                    </div>
                    <span asp-validation-for="PorcentajeIva" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="StockInicial" class="form-label">Stock Inicial</label>
                    <input asp-for="StockInicial" class="form-control bg-dark text-light" value="@(Model.ProductoID > 0 ? 0 : 0)" />
                    <span asp-validation-for="StockInicial" class="text-danger"></span>
                    @if (Model.ProductoID > 0)
                    {
                        <small class="text-info">Cantidad actual: @Model.CantidadDisponible. Use ajuste de stock para cambios mayores.</small>
                    }
                </div>
            </div>

            <div class="mb-3">
                <label asp-for="Descripcion" class="form-label">Descripción</label>
                <textarea asp-for="Descripcion" class="form-control bg-dark text-light" rows="3"></textarea>
                <span asp-validation-for="Descripcion" class="text-danger"></span>
            </div>
            <div class="d-flex justify-content-end">
                <a asp-action="Index" class="btn btn-outline-secondary me-2">
                    <i class="bi bi-arrow-left"></i> Volver
                </a>
                @if ((Model.ProductoID > 0 && User.HasPermission("productos.editar")) ||
                (Model.ProductoID == 0 && User.HasPermission("productos.crear")))
                {
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Guardar
                    </button>
                }
            </div>
        </form>
    </div>
</div>

<!-- Modal Nuevo Rubro -->
<div class="modal fade" id="nuevoRubroModal" tabindex="-1" aria-labelledby="nuevoRubroModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="nuevoRubroModalLabel">Crear Nuevo Rubro</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="nombreRubro" class="form-label">Nombre del Rubro</label>
                    <input type="text" class="form-control bg-dark text-light" id="nombreRubro" />
                    <div id="errorRubro" class="text-danger"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarRubro">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nuevo SubRubro -->
<div class="modal fade" id="nuevoSubRubroModal" tabindex="-1" aria-labelledby="nuevoSubRubroModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="nuevoSubRubroModalLabel">Crear Nuevo SubRubro</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="rubroID" class="form-label">Rubro</label>
                    <select class="form-select bg-dark text-light" id="rubroID" disabled>
                        <option value="">-- Seleccione Rubro --</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="nombreSubRubro" class="form-label">Nombre del SubRubro</label>
                    <input type="text" class="form-control bg-dark text-light" id="nombreSubRubro" />
                    <div id="errorSubRubro" class="text-danger"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarSubRubro">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nueva Marca -->
<div class="modal fade" id="nuevaMarcaModal" tabindex="-1" aria-labelledby="nuevaMarcaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="nuevaMarcaModalLabel">Crear Nueva Marca</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="nombreMarca" class="form-label">Nombre de la Marca</label>
                    <input type="text" class="form-control bg-dark text-light" id="nombreMarca" />
                    <div id="errorMarca" class="text-danger"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarMarca">Guardar</button>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
        <script src="~/js/Productos/Form.js"></script>

    }

}