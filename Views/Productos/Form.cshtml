@model Javo2.ViewModels.Operaciones.Productos.ProductosViewModel
@inject Javo2.IServices.IProductoService ProductoService

@{
    var isEdit = Model.ProductoID > 0;
    ViewBag.Title = isEdit ? "Editar Producto" : "Crear Producto";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Cargar producto para mostrar nombre/descr en edición
    var producto = isEdit
        ? await ProductoService.GetProductoByIDAsync(Model.ProductoID)
        : null;
}

<section class="container-fluid py-3">
    <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8">
            <div class="card shadow-sm bg-dark text-light">
                <div class="card-header">
                    <h2 class="h5 mb-0">@ViewBag.Title</h2>
                </div>
                <div class="card-body">
                    @if (producto != null)
                    {
                        <div class="mb-4">
                            <h4>@producto.Nombre</h4>
                            @if (!string.IsNullOrWhiteSpace(producto.Descripcion))
                            {
                                <p class="text-muted">@producto.Descripcion</p>
                            }
                        </div>
                    }

                    <form asp-action="@(isEdit ? "Edit" : "Create")" method="post" novalidate>
                        @Html.AntiForgeryToken()
                        @Html.HiddenFor(m => m.ProductoID)
                        @Html.HiddenFor(m => m.ModificadoPor)

                        <!-- Información Básica -->
                        <fieldset class="mb-4">
                            <legend class="text-light">Información Básica</legend>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label asp-for="Nombre" class="form-label text-light">Nombre</label>
                                    <input asp-for="Nombre"
                                           class="form-control bg-secondary text-light"
                                           placeholder="Ingrese nombre" />
                                    <span asp-validation-for="Nombre" class="invalid-feedback d-block"></span>
                                </div>
                                <div class="col-12">
                                    <label asp-for="Descripcion" class="form-label text-light">Descripción</label>
                                    <textarea asp-for="Descripcion"
                                              class="form-control bg-secondary text-light"
                                              rows="3"
                                              placeholder="Describe el producto"></textarea>
                                    <span asp-validation-for="Descripcion" class="invalid-feedback d-block"></span>
                                </div>
                            </div>
                        </fieldset>

                        <!-- Precios e IVA -->
                        <fieldset class="mb-4">
                            <legend class="text-light">Precios e IVA</legend>
                            <div class="row g-3">
                                <div class="col-md-6 col-lg-3">
                                    <label asp-for="PCosto" class="form-label text-light">Precio Costo</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-secondary text-light">$</span>
                                        <input asp-for="PCosto"
                                               type="number" step="0.01"
                                               class="form-control bg-secondary text-light"
                                               placeholder="0.00" />
                                    </div>
                                    <span asp-validation-for="PCosto" class="invalid-feedback d-block"></span>
                                </div>
                                <div class="col-md-6 col-lg-3">
                                    <label asp-for="PContado" class="form-label text-light">Precio Contado</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-secondary text-light">$</span>
                                        <input asp-for="PContado"
                                               type="number" step="0.01"
                                               class="form-control bg-secondary text-light"
                                               placeholder="0.00" />
                                    </div>
                                    <span asp-validation-for="PContado" class="invalid-feedback d-block"></span>
                                </div>
                                <div class="col-md-6 col-lg-3">
                                    <label asp-for="PLista" class="form-label text-light">Precio Lista</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-secondary text-light">$</span>
                                        <input asp-for="PLista"
                                               type="number" step="0.01"
                                               class="form-control bg-secondary text-light"
                                               placeholder="0.00" />
                                    </div>
                                    <span asp-validation-for="PLista" class="invalid-feedback d-block"></span>
                                </div>
                                <div class="col-md-6 col-lg-3">
                                    <label asp-for="PorcentajeIva" class="form-label text-light">% IVA</label>
                                    <div class="input-group">
                                        <input asp-for="PorcentajeIva"
                                               type="number" step="0.01"
                                               class="form-control bg-secondary text-light"
                                               placeholder="21" />
                                        <span class="input-group-text bg-secondary text-light">%</span>
                                    </div>
                                    <span asp-validation-for="PorcentajeIva" class="invalid-feedback d-block"></span>
                                </div>
                            </div>
                        </fieldset>

                        <!-- Inventario -->
                        <fieldset class="mb-4">
                            <legend class="text-light">Inventario</legend>
                            <div class="row g-3">
                                @if (isEdit)
                                {
                                    <div class="col-md-6">
                                        <label asp-for="CantidadDisponible" class="form-label text-light">Stock Actual</label>
                                        <input asp-for="CantidadDisponible"
                                               readonly
                                               class="form-control bg-secondary text-light" />
                                    </div>
                                    <div class="col-md-6">
                                        <label asp-for="StockInicial" class="form-label text-light">Ajustar Stock</label>
                                        <div class="input-group">
                                            <input asp-for="StockInicial"
                                                   type="number"
                                                   class="form-control bg-secondary text-light"
                                                   placeholder="0" />
                                            <span class="input-group-text bg-secondary text-light">unidades</span>
                                        </div>
                                        <small class="form-text text-muted">
                                            Positivo para sumar, negativo para restar
                                        </small>
                                        <span asp-validation-for="StockInicial" class="invalid-feedback d-block"></span>
                                    </div>
                                }
                                else
                                {
                                    <div class="col-md-6">
                                        <label asp-for="StockInicial" class="form-label text-light">Stock Inicial</label>
                                        <div class="input-group">
                                            <input asp-for="StockInicial"
                                                   type="number"
                                                   class="form-control bg-secondary text-light"
                                                   placeholder="0" />
                                            <span class="input-group-text bg-secondary text-light">unidades</span>
                                        </div>
                                        <span asp-validation-for="StockInicial" class="invalid-feedback d-block"></span>
                                    </div>
                                }
                            </div>
                        </fieldset>

                        <!-- Clasificación -->
                        <fieldset class="mb-4">
                            <legend class="text-light">Clasificación</legend>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label asp-for="SelectedRubroID" class="form-label text-light">Rubro</label>
                                    <div class="input-group">
                                        <select asp-for="SelectedRubroID"
                                                class="form-select bg-secondary text-light"
                                                asp-items="Model.Rubros"
                                                id="rubroSelect">
                                            <option value="">Seleccione Rubro</option>
                                        </select>
                                        <button type="button"
                                                class="btn btn-outline-light"
                                                data-bs-toggle="modal"
                                                data-bs-target="#rubroModal"
                                                title="Añadir Rubro">
                                            <i class="bi bi-plus-lg"></i>
                                        </button>
                                    </div>
                                    <span asp-validation-for="SelectedRubroID" class="invalid-feedback d-block"></span>
                                </div>
                                <div class="col-md-4">
                                    <label asp-for="SelectedSubRubroID" class="form-label text-light">SubRubro</label>
                                    <div class="input-group">
                                        <select asp-for="SelectedSubRubroID"
                                                class="form-select bg-secondary text-light"
                                                asp-items="Model.SubRubros"
                                                id="subRubroSelect">
                                            <option value="">Seleccione SubRubro</option>
                                        </select>
                                        <button type="button"
                                                class="btn btn-outline-light"
                                                data-bs-toggle="modal"
                                                data-bs-target="#subRubroModal"
                                                id="btnAddSubRubro"
                                                disabled
                                                title="Añadir SubRubro">
                                            <i class="bi bi-plus-lg"></i>
                                        </button>
                                    </div>
                                    <span asp-validation-for="SelectedSubRubroID" class="invalid-feedback d-block"></span>
                                </div>
                                <div class="col-md-4">
                                    <label asp-for="SelectedMarcaID" class="form-label text-light">Marca</label>
                                    <div class="input-group">
                                        <select asp-for="SelectedMarcaID"
                                                class="form-select bg-secondary text-light"
                                                asp-items="Model.Marcas"
                                                id="marcaSelect">
                                            <option value="">Seleccione Marca</option>
                                        </select>
                                        <button type="button"
                                                class="btn btn-outline-light"
                                                data-bs-toggle="modal"
                                                data-bs-target="#marcaModal"
                                                title="Añadir Marca">
                                            <i class="bi bi-plus-lg"></i>
                                        </button>
                                    </div>
                                    <span asp-validation-for="SelectedMarcaID" class="invalid-feedback d-block"></span>
                                </div>
                            </div>
                        </fieldset>

                        <!-- Acciones -->
                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="bi bi-save me-1"></i>
                                @(isEdit ? "Actualizar" : "Crear")
                            </button>
                            <a asp-action="Index" class="btn btn-outline-light">
                                <i class="bi bi-arrow-left me-1"></i> Volver
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal Rubro -->
<div class="modal fade" id="rubroModal" tabindex="-1" aria-labelledby="rubroModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 id="rubroModalLabel" class="modal-title">Agregar Nuevo Rubro</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label for="nuevoRubroNombre" class="form-label">Nombre del Rubro</label>
                <input id="nuevoRubroNombre" class="form-control bg-secondary text-light" />
                <div id="rubroError" class="invalid-feedback"></div>
            </div>
            <div class="modal-footer">
                <button data-bs-dismiss="modal" class="btn btn-secondary">Cancelar</button>
                <button id="saveRubroBtn" class="btn btn-success">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal SubRubro -->
<div class="modal fade" id="subRubroModal" tabindex="-1" aria-labelledby="subRubroModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 id="subRubroModalLabel" class="modal-title">Agregar Nuevo SubRubro</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="rubroIDForSubRubro" />
                <label for="rubroForSubRubro" class="form-label">Rubro</label>
                <input id="rubroForSubRubro" readonly class="form-control bg-secondary text-light mb-3" />
                <label for="nuevoSubRubroNombre" class="form-label">Nombre del SubRubro</label>
                <input id="nuevoSubRubroNombre" class="form-control bg-secondary text-light" />
                <div id="subRubroError" class="invalid-feedback"></div>
            </div>
            <div class="modal-footer">
                <button data-bs-dismiss="modal" class="btn btn-secondary">Cancelar</button>
                <button id="saveSubRubroBtn" class="btn btn-success">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Marca -->
<div class="modal fade" id="marcaModal" tabindex="-1" aria-labelledby="marcaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 id="marcaModalLabel" class="modal-title">Agregar Nueva Marca</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label for="nuevoMarcaNombre" class="form-label">Nombre de la Marca</label>
                <input id="nuevoMarcaNombre" class="form-control bg-secondary text-light" />
                <div id="marcaError" class="invalid-feedback"></div>
            </div>
            <div class="modal-footer">
                <button data-bs-dismiss="modal" class="btn btn-secondary">Cancelar</button>
                <button id="saveMarcaBtn" class="btn btn-success">Guardar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
    <script defer>
        (function($){
          $(function(){
            const token = $('input[name="__RequestVerificationToken"]').val();

            // Al cambiar rubro: recargar subrubros + habilitar botón
            $('#rubroSelect').change(function(){
              var id = $(this).val();
              var sub = $('#subRubroSelect').empty()
                            .append('<option>Cargando...</option>');
              $('#btnAddSubRubro').prop('disabled', !id);
              if(!id) { sub.html('<option>Seleccione...</option>'); return; }
              $.getJSON('@Url.Action("GetSubRubros", "Productos")',{rubroId:id})
                .done(data=>{
                  sub.empty().append('<option>Seleccione SubRubro</option>');
                  data.forEach(i=> sub.append(
                    $('<option>').val(i.value).text(i.text)
                  ));
                })
                .fail(()=>{
                  sub.html('<option>Error al cargar</option>');
                });
            });

            // Inicializar si edición
        @if (isEdit && Model.SelectedRubroID > 0)
        {
            <text>$('#rubroSelect').trigger('change');</text>
        }

            // Create Rubro AJAX
            $('#saveRubroBtn').click(()=>{
              var nombre = $('#nuevoRubroNombre').val().trim();
              if(!nombre){
                $('#rubroError').text('Requerido').show();
                return;
              }
              $('#saveRubroBtn').prop('disabled',true).text('Guardando…');
              $.post('@Url.Action("CreateRubroAjax", "Catalogo")',
                { Nombre:nombre, __RequestVerificationToken:token })
              .done(resp=>{
                if(resp.success){
                  $('#rubroSelect')
                    .append($('<option>').val(resp.id).text(resp.name))
                    .val(resp.id).trigger('change');
                  $('#rubroModal').modal('hide');
                  $('#nuevoRubroNombre').val('');
                  $('#rubroError').hide();
                } else {
                  $('#rubroError').text(resp.message).show();
                }
              })
              .fail(()=> $('#rubroError').text('Error de conexión').show())
              .always(()=> $('#saveRubroBtn').prop('disabled',false).text('Guardar'));
            });

            // Create SubRubro AJAX
            $('#saveSubRubroBtn').click(()=>{
              var rubroId = $('#rubroIDForSubRubro').val();
              var nombre = $('#nuevoSubRubroNombre').val().trim();
              if(!nombre){ $('#subRubroError').text('Requerido').show(); return; }
              $('#saveSubRubroBtn').prop('disabled',true).text('Guardando…');
              $.post('@Url.Action("CreateSubRubroAjax", "Catalogo")',
                { Nombre:nombre, RubroID:rubroId, __RequestVerificationToken:token })
              .done(resp=>{
                if(resp.success){
                  $('#subRubroSelect')
                    .append($('<option>').val(resp.id).text(resp.name))
                    .val(resp.id);
                  $('#subRubroModal').modal('hide');
                  $('#nuevoSubRubroNombre').val('');
                  $('#subRubroError').hide();
                } else {
                  $('#subRubroError').text(resp.message).show();
                }
              })
              .fail(()=> $('#subRubroError').text('Error de conexión').show())
              .always(()=> $('#saveSubRubroBtn').prop('disabled',false).text('Guardar'));
            });

            // Create Marca AJAX
            $('#saveMarcaBtn').click(()=>{
              var nombre = $('#nuevoMarcaNombre').val().trim();
              if(!nombre){ $('#marcaError').text('Requerido').show(); return; }
              $('#saveMarcaBtn').prop('disabled',true).text('Guardando…');
              $.post('@Url.Action("CreateMarcaAjax", "Catalogo")',
                { Nombre:nombre, __RequestVerificationToken:token })
              .done(resp=>{
                if(resp.success){
                  $('#marcaSelect')
                    .append($('<option>').val(resp.id).text(resp.name))
                    .val(resp.id);
                  $('#marcaModal').modal('hide');
                  $('#nuevoMarcaNombre').val('');
                  $('#marcaError').hide();
                } else {
                  $('#marcaError').text(resp.message).show();
                }
              })
              .fail(()=> $('#marcaError').text('Error de conexión').show())
              .always(()=> $('#saveMarcaBtn').prop('disabled',false).text('Guardar'));
            });

          });
        })(jQuery);
    </script>
}
